<!DOCTYPE html>
<html>
  <head>
    <title>DMV - Drive Molecule Viewer</title>
    <meta charset="utf-8" />
    <meta name="description" content="A 3D interactive molecule viewer for Google products like Gmail or Drive">
    <meta name="keywords" content="molecule,viewer,drive,gmail">
    <meta name="author" content="Jaime RGP">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <style>
      body {
          overflow: hidden;
          margin: 0;
          padding: 0;
      }
      .ngl-viewport {
          position: absolute;
          width: 100%;
          height: 100vh;
          overflow: hidden;
      }
      #bottombar {
        position: absolute;
        height: 1em;
        width: 100%;
        bottom: 1.25em;
        left: 0.25em;
      }

    </style>
  </head>

  <body>
    <div id='viewport' class='ngl-viewport'></div>
    <div id='bottombar'>
      <p id='filedescr'></p>
    </div>
  </body>
    <!-- Scripts -->
  <script>
    function onLoadRouter(){
      google.script.url.getLocation(function(location) {
        fileid = location.parameter.fileid;
        if (fileid) {
          fetchFile(fileid);
        }
    });
    }
    function fetchFile(fileid){
      google.script.run.withSuccessHandler(LoadNGLMolecule).getFileById(fileid);
    }
    function LoadNGLMolecule(response) {
      if (!response) {
        return;
      }
      document.Resp = response;
      console.log(response.filename);
      console.log(response.blob);
      var molecule = new Blob([response.blob], {type: 'text/plain'});
      var filename = response.filename;
      var filenameinfo = NGL.getFileInfo(filename);
      if (!NGL.ParserRegistry.isStructure(filenameinfo.ext)){
        return null;
      }
      if (!document.NGLStage) {
        document.NGLStage = new NGL.Stage("viewport",
        { fogNear: 100, fogFar: 100, backgroundColor: 'white' });
      }
      document.getElementById('filedescr').innerText = '';
      document.NGLStage.removeAllComponents();
      document.NGLStage.moleculeName = filename;
      document.getElementById('filedescr').innerText = filename;
      document.NGLStage.loadFile(molecule, {ext: filenameinfo.ext})
        .then(function (component) {
          var sele = 'not (_C or _H or _N or _O)';
          component.addRepresentation("cartoon");  // for proteins
          component.addRepresentation("licorice", { multipleBond: "symmetric" }); // for ligands
          component.addRepresentation("ball+stick", { sele: sele, aspectRatio: 3.0 }); // for metals
          // add labels to non-CHON atoms
          var labelText = {}
          var selectionObject = new NGL.Selection(sele);
          component.structure.eachAtom(function (AtomProxy) {
            var elem = AtomProxy.element
            labelText[AtomProxy.index] = elem.charAt(0).toUpperCase() + elem.slice(1).toLowerCase();
          }, selectionObject);
          component.addRepresentation(
            'label', {
            sele: sele,
            color: '#222222',
            name: 'non-CHON element',
            labelType: 'text',
            labelText: labelText,
            xOffset: 0.5,
            showBorder: true,
            borderColor: '#FFFFFF',
            borderWidth: 0.05,
            sdf: true
            }
        );
        // provide a "good" view of the structure
        component.autoView();
    });
    };
    window.addEventListener('resize', function(event){
      if (document.NGLStage) {
        document.NGLStage.handleResize();
      };
    });
    document.addEventListener('DOMContentLoaded', onLoadRouter, false);
  </script>
  <script src="https://unpkg.com/ngl@next" defer></script>
</html>